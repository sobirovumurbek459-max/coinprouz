<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ClickCoin Pro ‚Äî Telegram WebApp</title>
<style>
:root{--bg:#041026;--card:#0e1630;--muted:#9fb0ff;--accent:#7c5cff}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, Roboto, Arial, sans-serif;background:linear-gradient(180deg,#02101f,#041026);color:#eaf0ff}
.app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;padding-bottom:78px}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px}
.brand{font-weight:800}
.pills{display:flex;gap:8px}
.pill{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:12px}
main{flex:1;padding:12px}
.screen{display:none}
.screen.active{display:block}
.center{display:flex;flex-direction:column;align-items:center;gap:12px}
.coin-btn{width:min(66vw,360px);aspect-ratio:1/1;border-radius:50%;display:grid;place-items:center;font-size:clamp(36px,10vw,88px);cursor:pointer;border:8px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(0,0,0,0.5);background:radial-gradient(circle at 30% 30%, #fff7b2, #ffd24d)}
.energy-bar{width:86%;height:18px;background:#1b2433;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);display:flex}
.energy-fill{height:100%;background:linear-gradient(90deg,#ffdd55,#7cffb0);transition:width .2s linear}
.energy-empty{height:100%;background:#2b3347}
.card{background:rgba(14,22,48,0.95);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}
.small{font-size:13px;color:var(--muted)}
.shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(min-width:720px){.shop-grid{grid-template-columns:repeat(3,1fr)}}
.btn{padding:8px 10px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
.btn.primary{background:linear-gradient(180deg,var(--accent),#613bff);color:#06102a}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:#e8f0ff}
.leader{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.04)}
.input{width:100%;padding:10px;border-radius:8px;border:0;background:#09132a;color:#dfe8ff}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:92px;background:#0f1431;padding:10px 14px;border-radius:10px;display:none}
.badge{background:#0b1430;padding:6px 8px;border-radius:10px;font-weight:800}
.gift-visual{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;font-weight:900;color:#fff}
.gift-visual.gold{background:linear-gradient(180deg,#ffd86b,#ffb84d)}
.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:64px;background:#08132a;display:flex;justify-content:space-around;align-items:center;border-top:1px solid rgba(255,255,255,0.03)}
.bottom-nav button{background:none;border:0;color:#eaf0ff;font-weight:800;padding:10px;cursor:pointer}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">ClickCoin Pro</div>
    <div class="pills">
      <div class="pill">ü™ô <span id="uiCoins">0</span></div>
      <div class="pill">‚ö° <span id="uiEnergy">0</span></div>
    </div>
  </div>

  <main>
    <section id="home" class="screen active">
      <div class="center">
        <div class="small">User: <b id="uiName">-</b></div>
        <button id="coinBtn" class="coin-btn" aria-label="tap">üü°</button>
        <div style="width:86%;display:flex;flex-direction:column;align-items:center">
          <div class="energy-bar" aria-label="energy">
            <div id="energyFill" class="energy-fill" style="width:100%"></div>
            <div id="energyEmpty" class="energy-empty" style="width:0%"></div>
          </div>
          <div class="small" style="margin-top:6px">Energy: <span id="uiEnergyVal">100</span>/<span id="uiMaxEnergy">100</span></div>
        </div>
      </div>
    </section>

    <section id="shop" class="screen">
      <h3>Shop & Skins</h3>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:800">Tap Upgrade</div><div class="small">+1 per buy</div></div>
          <div style="text-align:right"><div class="badge" id="priceTap">20</div><div style="margin-top:8px"><button id="buyTap" class="btn primary">Buy</button></div></div>
        </div>
      </div>
      <div class="card"><h4>Skins (Each skin gives bonuses)</h4><div id="skinsGrid" class="shop-grid"></div></div>
    </section>

    <section id="friends" class="screen">
      <h3>Referral</h3>
      <div class="card"><div class="small">Referral link (only one):</div><input id="refLink" class="input" readonly /><div style="margin-top:8px"><button id="copyRef" class="btn ghost">Copy Referral</button></div></div>
      <div class="card"><div class="small">Invited: <b id="uiInvited">0</b></div><div class="small">Referral bonus total: <b id="uiRefTotal">0</b></div></div>
    </section>

    <section id="giftbox" class="screen">
      <h3>Gift Boxes</h3>
      <div id="giftGrid" class="shop-grid"></div>
    </section>

    <section id="leaderboard" class="screen">
      <h3>üèÜ Global Leaderboard</h3>
      <div class="card small">Top players from server</div>
      <div id="leaderList" class="card"></div>
      <div style="margin-top:8px"><button id="btnSaveScore" class="btn primary">Submit Score (Global)</button></div>
      <div class="small" style="margin-top:8px">Or press <b>P</b> to submit score.</div>
    </section>

    <section id="settings" class="screen">
      <h3>Settings</h3>
      <div class="card"><div class="small">Sound: <button id="toggleSound" class="btn ghost">Toggle</button></div><div class="small">Theme: <button id="toggleTheme" class="btn ghost">Toggle</button></div></div>
    </section>
  </main>

  <div class="bottom-nav">
    <button class="nav-btn" data-screen="home">üè† Home</button>
    <button class="nav-btn" data-screen="shop">üõí Shop</button>
    <button class="nav-btn" data-screen="friends">üë• Referral</button>
    <button class="nav-btn" data-screen="giftbox">üéÅ Giftbox</button>
    <button class="nav-btn" data-screen="leaderboard">üèÜ Leaderboard</button>
    <button class="nav-btn" data-screen="settings">‚öôÔ∏è Settings</button>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
/* ---------- SET THIS to your deployed backend URL (after deploy) ---------- */
let API_URL = '{{REPLACE_WITH_BACKEND_URL}}'; // e.g. 'https://my-backend.up.railway.app' or 'http://localhost:3000'

/* ---------- State & defaults ---------- */
const KEY = 'clickcoin_telegram_v1';
function defaultState(){ return { name:null, coins:0, totalEarned:0, perTap:1, tapLevel:0, maxEnergy:100, energy:100, energyRegenPerSec:0.25, boost:{mult:1,until:0}, bots:{level:0,cps:0}, prices:{tap:20,bot:200,boost:150,energyRefill:5000,luckyChest:1000}, skinsOwned:['classic'], skin:'classic', invites:0, refTotal:0, giftLastOpen:{} }; }
let S = loadState();
function loadState(){ try{ const raw=localStorage.getItem(KEY); return raw?Object.assign(defaultState(), JSON.parse(raw)):defaultState(); }catch(e){ return defaultState(); } }
function saveState(){ localStorage.setItem(KEY, JSON.stringify(S)); }

/* ---------- UI refs ---------- */
const ui = { coins: document.getElementById('uiCoins'), energyVal: document.getElementById('uiEnergyVal'), maxEnergy: document.getElementById('uiMaxEnergy'), energyFill: document.getElementById('energyFill'), energyEmpty: document.getElementById('energyEmpty'), coinBtn: document.getElementById('coinBtn'), skinsGrid: document.getElementById('skinsGrid'), giftGrid: document.getElementById('giftGrid'), leaderList: document.getElementById('leaderList'), refLink: document.getElementById('refLink'), copyRef: document.getElementById('copyRef'), uiName: document.getElementById('uiName'), priceTap: document.getElementById('priceTap'), btnSaveScore: document.getElementById('btnSaveScore'), uiInvited: document.getElementById('uiInvited'), uiRefTotal: document.getElementById('uiRefTotal') };

/* ---------- Helpers ---------- */
function showToast(msg, t=1400){ const tEl=document.getElementById('toast'); tEl.textContent=msg; tEl.style.display='block'; setTimeout(()=>tEl.style.display='none',t); }
function fmt(n){ if(n>=1e9) return (n/1e9).toFixed(2)+'B'; if(n>=1e6) return (n/1e6).toFixed(2)+'M'; if(n>=1e3) return (n/1e3).toFixed(2)+'K'; return Math.floor(n).toString(); }
function nowDayKey(ts=Date.now()){ const d=new Date(ts); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

/* ---------- Skins & Giftboxes ---------- */
const SKINS = [ {id:'classic', name:'Classic', price:0, icon:'‚óâ', color:'#ffd24d', bonus:{tap:1, energy:1}}, {id:'silver',  name:'Silver',  price:5000, icon:'S', color:'#cfd6dc', bonus:{tap:1.1, energy:1}}, {id:'gold',    name:'Gold',    price:25000, icon:'G', color:'#ffd24d', bonus:{tap:1.5, energy:1.5}}, {id:'sapphire',name:'Sapphire',price:100000,icon:'B', color:'#4ac6ff', bonus:{tap:2.0, energy:2}}, {id:'obsidian',name:'Obsidian',price:500000,icon:'‚óè', color:'#2b2b2b', bonus:{tap:3.0, energy:3}} ];
const GIFTBOXES = [ {id:0,name:'Free Box',price:0,baseMax:5000,rareChance:0.002,daily:true,description:'Kuniga 1 marta ‚Äî eng katta 5,000 (0.2%)'}, {id:1,name:'Box 2',price:10000,baseMax:10000,rareChance:0.001,rareMax:100000,description:'Max 100,000 (0.1%)'}, {id:2,name:'Box 3',price:50000,baseMax:50000,rareChance:0.001,rareMax:300000,description:'Max 300,000 (0.1%)'}, {id:3,name:'Box 4',price:200000,baseMax:200000,rareChance:0.001,rareMax:1000000,description:'Max 1,000,000 (0.1%)'}, {id:4,name:'Box 5',price:1000000,baseMax:1000000,rareChance:0.001,rareMax:5000000,description:'Max 5,000,000 (0.1%)'}, {id:5,name:'Super Box',price:10000000,baseMax:10000000,superChance:0.0001,superPrize:100000000,description:'Super prize: 100,000,000 (0.01%)'} ];

/* ---------- Init: Telegram + referral ---------- */
(function initAuth(){
  try{
    if(window.Telegram && window.Telegram.WebApp){
      const user = window.Telegram.WebApp.initDataUnsafe?.user;
      if(user) S.name = user.username || user.first_name || S.name || ('Guest'+Math.floor(Math.random()*9999));
      try{ window.Telegram.WebApp.expand(); }catch(e){}
    }
  }catch(e){}
  if(!S.name) S.name = 'Guest'+Math.floor(Math.random()*9999);

  try{
    const params = new URLSearchParams(location.search);
    const r = params.get('ref');
    if(r){
      fetch(API_URL + '/referral', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ref:r, newUser:S.name}) }).catch(()=>{});
    }
  }catch(e){}
  saveState();
})();

/* ---------- UI update ---------- */
function getSkinBonus(){ const s = SKINS.find(x=>x.id===S.skin); return s? s.bonus : {tap:1,energy:1}; }
function updateUI(){
  ui.coins.textContent = fmt(S.coins);
  ui.energyVal.textContent = Math.floor(S.energy);
  ui.maxEnergy && (ui.maxEnergy.textContent = S.maxEnergy);
  const pct = Math.max(0, Math.min(100, (S.energy/S.maxEnergy)*100));
  ui.energyFill.style.width = pct + '%';
  ui.energyEmpty.style.width = (100 - pct) + '%';
  ui.uiName && (ui.uiName.textContent = S.name);
  ui.priceTap && (ui.priceTap.textContent = S.prices.tap);
  ui.refLink && (ui.refLink.value = location.origin + location.pathname + '?ref=' + encodeURIComponent(S.name));
  ui.uiInvited && (ui.uiInvited.textContent = S.invites || 0);
  ui.uiRefTotal && (ui.uiRefTotal.textContent = fmt(S.refTotal || 0));
  saveState();
}

/* ---------- Click (home) ---------- */
ui.coinBtn.addEventListener('click', ()=>{
  if(S.energy <= 0){ showToast('Energiya tugadi'); return; }
  const bonus = getSkinBonus();
  const boostMult = (S.boost && S.boost.mult) || 1;
  const gain = S.perTap * bonus.tap * boostMult;
  S.coins += gain; S.totalEarned += gain;
  const energyCost = 1 / Math.max(1, bonus.energy);
  S.energy = Math.max(0, S.energy - energyCost);
  ui.coinBtn.style.transform = 'scale(.96)'; setTimeout(()=> ui.coinBtn.style.transform = '', 90);
  updateUI();
});

/* ---------- Shop actions ---------- */
document.getElementById('buyTap').addEventListener('click', ()=>{
  const price = S.prices.tap;
  if(S.coins < price){ showToast("Ko'proq coin kerak"); return; }
  S.coins -= price; S.perTap += 1; S.tapLevel += 1; S.prices.tap = Math.ceil(S.prices.tap * 1.6);
  showToast('Tap kuchi oshdi'); updateUI();
});

/* ---------- Skins rendering ---------- */
function renderSkins(){
  ui.skinsGrid.innerHTML = '';
  SKINS.forEach(s=>{
    const owned = S.skinsOwned.includes(s.id);
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px">
        <div class="skin-swatch" style="background:linear-gradient(180deg, ${s.color}, ${s.color}); color:#08102a">${s.icon}</div>
        <div style="flex:1">
          <div style="font-weight:800">${s.name}</div>
          <div class="small">${s.price>0? fmt(s.price)+' coins' : 'Default'}</div>
          <div class="small">Bonus: x${s.bonus.tap} click, x${s.bonus.energy} energy</div>
        </div>
        <div style="text-align:right">
          ${owned ? `<div class="small">Owned</div><button class="btn ghost" data-equip="${s.id}">Equip</button>` : `<div class="badge">${fmt(s.price)}</div><button class="btn primary" data-buy="${s.id}">Buy</button>`}
        </div>
      </div>`;
    ui.skinsGrid.appendChild(div);
  });
  ui.skinsGrid.querySelectorAll('[data-buy]').forEach(b=>{
    b.addEventListener('click', e=>{
      const id = e.currentTarget.getAttribute('data-buy'); const sk = SKINS.find(x=>x.id===id);
      if(!sk) return; if(S.coins < sk.price){ showToast("Ko'proq coin kerak"); return; }
      S.coins -= sk.price; S.skinsOwned.push(id); showToast(sk.name + ' sotib olindi'); updateUI(); renderSkins();
    });
  });
  ui.skinsGrid.querySelectorAll('[data-equip]').forEach(b=>{
    b.addEventListener('click', e=>{
      const id = e.currentTarget.getAttribute('data-equip'); S.skin = id; showToast('Skin o‚Äòrnatildi'); updateUI();
    });
  });
}

/* ---------- Giftboxes ---------- */
function renderGifts(){
  ui.giftGrid.innerHTML = '';
  GIFTBOXES.forEach(box=>{
    const div = document.createElement('div'); div.className='card';
    const dailyNote = box.daily ? `<div class="small">(Kuniga 1 marta)</div>` : '';
    const priceText = box.price>0 ? `<div class="badge">${fmt(box.price)}</div>` : `<div class="small">Free</div>`;
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="gift-visual gold">${box.id+1}</div>
          <div>
            <div style="font-weight:800">${box.name}</div>
            <div class="small">${box.description || ''}</div>
            ${dailyNote}
          </div>
        </div>
        <div style="text-align:right">
          ${priceText}
          <div style="margin-top:8px"><button class="btn primary" data-open="${box.id}">Open</button></div>
        </div>
      </div>`;
    ui.giftGrid.appendChild(div);
  });
  ui.giftGrid.querySelectorAll('[data-open]').forEach(b=> b.addEventListener('click', e=>{
    const id = Number(e.currentTarget.getAttribute('data-open')); openGift(id);
  }));
}
function canOpenBox(idx){ const box = GIFTBOXES.find(b=>b.id===idx); if(!box) return false; if(box.daily){ const last = S.giftLastOpen[idx] || 0; return nowDayKey(last) !== nowDayKey(); } else { return S.coins >= box.price; } }
function openGift(idx){ const box = GIFTBOXES.find(b=>b.id===idx); if(!box) return; if(!canOpenBox(idx)){ showToast('Bu boxni hozir ochib bo‚Äòlmaydi'); return; } if(!box.daily){ if(S.coins < box.price){ showToast('Yetarli coin yo‚Äòq'); return; } S.coins -= box.price; } if(box.superChance && Math.random() < box.superChance){ const prize = box.superPrize || 0; S.coins += prize; S.totalEarned += prize; S.giftLastOpen[idx] = Date.now(); showToast(`üéâ SUPER PRIZE! +${fmt(prize)}`, 2500); updateUI(); return; } if(box.rareChance && Math.random() < box.rareChance){ const rareMax = box.rareMax || box.baseMax; const prize = Math.floor(Math.random() * (rareMax*0.4) + Math.floor(rareMax*0.6)); S.coins += prize; S.totalEarned += prize; S.giftLastOpen[idx] = Date.now(); showToast(`üéâ Lucky! +${fmt(prize)}`,2000); updateUI(); return; } const prize = Math.floor(1 + Math.random() * box.baseMax); S.coins += prize; S.totalEarned += prize; S.giftLastOpen[idx] = Date.now(); showToast(`+${fmt(prize)}`); updateUI(); }

/* ---------- Referral copy ---------- */
ui.copyRef.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(ui.refLink.value); showToast('Referral copied'); }catch(e){ showToast('Copy failed'); } });

/* ---------- Leaderboard fetch & submit ---------- */
async function fetchLeaderboard(){ try{ const res = await fetch(API_URL + '/leaderboard'); if(!res.ok) throw new Error('network'); const data = await res.json(); ui.leaderList.innerHTML = data.map((p,i)=>`<div class="leader"><span>${i+1}. ${p.name}</span><b>${fmt(p.score)}</b></div>`).join(''); }catch(e){ ui.leaderList.innerHTML = '<div class="small">Server bilan bog‚Äòlanib bo‚Äòlmadi.</div>'; } }
ui.btnSaveScore.addEventListener('click', async ()=>{ try{ ui.btnSaveScore.disabled = true; await fetch(API_URL + '/submit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name:S.name, score: Math.floor(S.coins)}) }); showToast('Score yuborildi'); fetchLeaderboard(); }catch(e){ showToast('Yuborishda xato'); } finally{ ui.btnSaveScore.disabled = false; } });

/* ---------- Navigation binding ---------- */
document.querySelectorAll('.nav-btn').forEach(btn=>{ btn.addEventListener('click', ()=>{ const screen = btn.dataset.screen; document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(screen).classList.add('active'); if(screen==='shop') renderSkins(); if(screen==='giftbox') renderGifts(); if(screen==='leaderboard') fetchLeaderboard(); }); });

/* ---------- Keyboard shortcut ---------- */
document.addEventListener('keydown', e=>{ if(e.key==='p'||e.key==='P'){ ui.btnSaveScore.click(); } });

/* ---------- Game loop ---------- */
setInterval(()=>{ if(S.energy < S.maxEnergy) S.energy = Math.min(S.maxEnergy, S.energy + S.energyRegenPerSec * (getSkinBonus().energy)); if(S.bots.cps > 0){ const g = S.bots.cps; S.coins += g; S.totalEarned += g; } if(S.boost && S.boost.until && Date.now() >= S.boost.until){ S.boost = {mult:1,until:0}; showToast('Boost tugadi'); } updateUI(); }, 1000);
function getSkinBonus(){ const s = SKINS.find(x=>x.id===S.skin); return s? s.bonus : {tap:1,energy:1}; }
renderSkins(); renderGifts(); updateUI();
</script>
</body>
</html>